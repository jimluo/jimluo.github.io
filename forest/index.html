<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
        --accent-overlay-color: #fff;
        --body-bg: #fff;
        --body-color: #000;
        --heading-color: #000;
        --table-bg-even: #f3f3f3;
        --table-border-bottom: #dddddd;
      }
      
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;38c5aeca4d24ddfe00.png" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;74cf6cb0a69d143300.png" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;b7f9a884e270881000.png" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;67ecf87962747c1700.png" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;73ad5705c9d7c81300.png" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;1c22f6dd0a34f84400.png" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;f9196920c2e9808000.png" />
      
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="输出是最好的学习方式" />
        <meta name="twitter:description" content="输出是最好的学习方式">
      
    

    
      <meta name="twitter:title" content="Forest的daemon、cli流程和钱包结构">
    

    
      <link rel="prerender" href="https:&#x2F;&#x2F;github.com&#x2F;jimluo" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" />

    <title>
      
        
          Forest的daemon、cli流程和钱包结构
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://jimluo.github.io/main.css">
    
    
  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;ipfs&#x2F;">
  

  

  
    <link rel="prerender"  href="https://jimluo.github.io/tags/blockchain/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "Forest的daemon、cli流程和钱包结构",
      "image": [],
      "datePublished": "2022-07-05T00:00:00+00:00",
      "dateModified": "2022-07-05T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "罗进"
      },
       "publisher": {
        "@type": "Organization",
        "name": "罗进",
        "logo": {
          "@type": "ImageObject",
          "url": "https://jimluo.github.io/icon.png"
        }
        
      }
      
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "",
          "item": "https://jimluo.github.io/"
        },
        
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Forest的daemon、cli流程和钱包结构",
          "item": "https://jimluo.github.io/forest/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="https:&#x2F;&#x2F;github.com&#x2F;jimluo">Github</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>Forest的daemon、cli流程和钱包结构</h1>
    <small>
      July 05, 2022
      
        - 
        <span class="tags">
          
            <a href="https://jimluo.github.io/tags/blockchain/">Blockchain</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <p>去年了解过Filecoin，对其Go版的实现lotus运行和分析过，源于对IPFS的兴趣。</p>
<p>今年学习零知识证明时，简单过了下ref_fvm，同时分析Filecoin的Rust版forest时，提交2个小PR，都是关于wallet的。顺带记录了些学习笔记如下。</p>
<h3 id="qian-bao-de-gong-neng-xu-qiu">钱包的功能需求</h3>
<ul>
<li>挣钱：新区块的签名，转账时签名</li>
<li>收钱：老区块的验签，接收转账时验签</li>
</ul>
<h3 id="qian-bao-gong-neng-de-yue-shu">钱包功能的约束</h3>
<ul>
<li>多设备：导入多出在设备之间</li>
<li>多账户：增删改查多个账户</li>
</ul>
<h3 id="zhang-hu-de-ji-ben-jie-gou">账户的基本结构</h3>
<ul>
<li>私钥：分BLS聚合签和Secp256k1椭圆算法签名</li>
<li>公钥：对外提供的标识</li>
<li>地址：可视文本化的公钥</li>
</ul>
<h3 id="walletjie-gou">wallet结构</h3>
<ul>
<li>Wallet { keys&lt;Address, Key&gt;, keystore }</li>
<li>Key { KeyInfo, public_key, address }</li>
<li>KeyInfo { key_type, private_key }</li>
<li>Address { Net(main/test), payload(ID/Secp256k1/Actor/BLS) }</li>
<li>KeyStore { key_info&lt;addr, KeyInfo&gt;, persistence, encryption }
<img src="../images/wallet.png" alt="key_mangement" /></li>
</ul>
<h3 id="wallet-zi-ming-ling-de-liu-cheng">wallet 子命令的流程</h3>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>&gt; forest [wallet list | state lookup]</span><span>
</span><span>
</span><span>解析参数        *_cmd.rs [wallet_cmd | state_cmd ]</span><span>
</span><span>构造jsonrpc参数 *_opt.rs [wallet_opt | state_opt ]</span><span>
</span><span>
</span><span>call() -&gt; jsonrpc: </span><span>
</span><span>  reqest object   { version, method, params, id }</span><span>
</span><span>  response object { version, result, error, id }</span><span>
</span><span>
</span><span>key_mangement/wallet.rs</span><span>
</span><span>  list_addr() // 从KeyStore或state里获取</span><span>
</span></code></pre>
<p>改动的部分是参照lotus再list时能输出除Address外，还有此Address的Balance、Nonce、Default</p>
<p>将原来的list调用组合了对KeyStore的获取和state中的Balance的获取，但因json API中输出类型都是一个String，暂且去掉了Nonce。</p>
<h2 id="huan-you-1ge-bugzai-fen-xi-zhong">还有1个bug在分析中</h2>
<ul>
<li>有如下会输出错乱</li>
</ul>
<pre data-lang="log" style="background-color:#f9f9f9;color:#111111;" class="language-log "><code class="language-log" data-lang="log"><span> 2022-0X INFO  forest::daemon         &gt; Using network :: testnetnet</span><span>
</span><span> 2022-0X INFO  genesis                &gt; Importing chain from snapshot</span><span>
</span><span> 2022-0X INFO  genesis                &gt; Reading file...</span><span>
</span><span>Importing snapshot 3.34 GB / 3.91 GB [===============&gt;--------</span><span>
</span><span>Importing snapshot 3.34 GB / 3.91 GB [======================================-] 85.73 % 2.35</span><span>
</span><span>Importing snapshot 3.39 GB / 3.91 GB [=</span><span>
</span><span>Importing snapshot 3.</span><span>
</span><span>ImportingScanning blockchain 1079961 / 1086061 [============] 99.44 % 116.94/s 52s  </span><span>
</span><span> 2022-0X INFO  genesis                &gt; Accepting [Cid</span><span>
</span></code></pre>
<ul>
<li>也有bad_block引起的循环不停的Bootstrapping</li>
</ul>
<pre data-lang="log" style="background-color:#f9f9f9;color:#111111;" class="language-log "><code class="language-log" data-lang="log"><span>ERROR chain_sync::chain_muxer   &gt; Bootstrapping failed, re-evaluating the network head to retry the bootstrap. Error = </span><span>
</span><span> TipsetRangeSyncer(Validation(&quot;Validation error: Consensus error: StateManager error: failed to find state tree xxx &quot;))</span><span>
</span></code></pre>
<h3 id="daemonde-qi-dong-liu-cheng">daemon的启动流程</h3>
<ul>
<li>start
<ul>
<li>read keystore</li>
<li>start promithus</li>
<li>print token</li>
<li>init db</li>
<li>chain_store, publish, set_genesis</li>
<li>genesis, tipset, read_genesis_head</li>
</ul>
</li>
<li>libp2p</li>
<li>mpoll</li>
<li>consensus</li>
<li>chainMuxer</li>
<li>p2p</li>
</ul>
<h4 id="qi-zhong-zhu-yao-de-task">其中主要的task</h4>
<ul>
<li>mining</li>
<li>prometheus</li>
<li>p2p</li>
<li>rpc</li>
<li>sync: chainMuxer</li>
</ul>
<h5 id="bad-block-check">bad_block check</h5>
<pre data-lang="sh" style="background-color:#f9f9f9;color:#111111;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#c82728;">❯</span><span style="color:#4271ae;"> ./target/release/forest</span><span style="color:#f07219;"> --import-snapshot</span><span style="color:#4271ae;"> ./lotus_cali_snapshot_2022_07_01_high_1086060.car</span><span>
</span><span style="color:#c82728;">WARN</span><span style="color:#4271ae;">  forest::cli </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> No configurations found, using defaults.</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  forest::daemon </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Starting Forest daemon, version v0.2.2/alpha/2777962b</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  forest_libp2p::service </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Recovered libp2p keypair from </span><span style="color:#839c00;">&quot;/root/.local/share/forest/libp2p/keypair&quot;</span><span>
</span><span style="color:#c82728;">Enter</span><span style="color:#4271ae;"> the keystore passphrase:</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  forest::daemon         </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Prometheus server started at 127.0.0.1:6116</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  forest::daemon         </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Admin token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJBbGxvdyI6WyJyZWFkIiwid3JpdGUiLCJzaWduIiwiYWRtaW4</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  genesis                </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Initialized genesis: BlockHeader: Cid(bafy2bzacecnamqgqmifpluoeldx7zzglxcljo6oja4vrmtj7432rphldpdmm2</span><span>)</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  forest::daemon         </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Using network :: testnetnet</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  genesis                </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Importing chain from snapshot</span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  genesis                </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Reading file...</span><span>
</span><span style="color:#c82728;">Importing</span><span style="color:#4271ae;"> snapshot 3.34 GB / 3.91 GB [===============</span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;">--------</span><span>
</span><span style="color:#c82728;">Importing</span><span style="color:#4271ae;"> snapshot 3.34 GB / 3.91 GB </span><span style="color:#8959a8;">[</span><span style="color:#4271ae;">======================================-</span><span style="color:#8959a8;">]</span><span style="color:#4271ae;"> 85.73 % 2.35</span><span>
</span><span style="color:#c82728;">Importing</span><span style="color:#4271ae;"> snapshot 3.39 GB / 3.91 GB [=</span><span>
</span><span style="color:#c82728;">Importing</span><span style="color:#4271ae;"> snapshot 3.</span><span>
</span><span style="color:#c82728;">ImportingScanning</span><span style="color:#4271ae;"> blockchain 1079961 / 1086061 </span><span style="color:#8959a8;">[</span><span style="color:#4271ae;">============</span><span style="color:#8959a8;">]</span><span style="color:#4271ae;"> 99.44 % 116.94/s 52s  </span><span>
</span><span style="color:#c82728;">INFO</span><span style="color:#4271ae;">  genesis                </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Accepting </span><span style="color:#8959a8;">[</span><span style="color:#4271ae;">Cid(bafy2bzaced3lqekadp5wwveksrfq3ulh43eq36gtgqqdsksfqfarb7aujncne), Cid(bafy2bzacedizgfupmw3loypx2dcczgaykmymzrnovupegthmwnbsslfsov4ua), Cid(bafy2bzaced4jfbzyol4qft4h4tkacco77z6aa2m4qkm573xanmyv3jdjier2m)</span><span style="color:#8959a8;">]</span><span style="color:#4271ae;"> as new head.</span><span>
</span><span style="color:#c82728;">ERROR</span><span style="color:#4271ae;"> forest::cli            </span><span style="color:#3e999f;">&gt;</span><span style="color:#4271ae;"> Error: Database too old. Download a snapshot from a trusted source and import with</span><span style="color:#f07219;"> --import-snapshot</span><span style="color:#3e999f;">=</span><span style="color:#8959a8;">[</span><span style="color:#4271ae;">file</span><span style="color:#8959a8;">]</span><span>
</span></code></pre>
<pre data-lang="sh" style="background-color:#f9f9f9;color:#111111;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#c82728;">Starting</span><span style="color:#4271ae;"> Forest daemon</span><span>
</span><span style="color:#c82728;">Recovered</span><span style="color:#4271ae;"> libp2p keypair from </span><span style="color:#839c00;">&quot;/root/.local/share/forest/libp2p/keypair&quot;</span><span>
</span><span style="color:#c82728;">...</span><span>
</span><span style="color:#c82728;">chain_muxer:</span><span style="color:#4271ae;"> Bootstrapping failed, re-evaluating the network head to retry the bootstrap. Error = TipsetRangeSyncer(Validation(</span><span style="color:#839c00;">&quot;Validation error: Consensus error: StateManager error: failed to find state tree bafy2bzacebbm4ympalhar75tlczmwpg3xkrh5txt56dluvam65it334zg5gke&quot;</span><span>))</span><span>
</span><span>
</span><span style="color:#c82728;">chain_muxer:</span><span style="color:#4271ae;"> Bootstrapping failed, 重复尝试并不停报错</span><span>
</span></code></pre>
<p>还在分析中，抽空攒个大块时间处理</p>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    
      <div class="link">
        Previous <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;ipfs&#x2F;">IPFS与web2.0的简单比较</a>
      </div>
    

    

  </div>


    </main>
    <footer class="footer-page">
    
      
        <p>© 2022, Jim Luo | simple-dev-blog theme on Zola</p>

      
    
    </footer>
  </body>
</html>
