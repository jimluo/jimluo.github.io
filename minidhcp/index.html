<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
        --accent-overlay-color: #fff;
        --body-bg: #fff;
        --body-color: #000;
        --heading-color: #000;
        --table-bg-even: #f3f3f3;
        --table-border-bottom: #dddddd;
      }
      
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;38c5aeca4d24ddfe00.png" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;74cf6cb0a69d143300.png" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;b7f9a884e270881000.png" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;67ecf87962747c1700.png" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;73ad5705c9d7c81300.png" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;1c22f6dd0a34f84400.png" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;f9196920c2e9808000.png" />
      
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="输出是最好的学习方式" />
        <meta name="twitter:description" content="输出是最好的学习方式">
      
    

    
      <meta name="twitter:title" content="开发minidhcp的感受记录">
    

    
      <link rel="prerender" href="https:&#x2F;&#x2F;github.com&#x2F;jimluo" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" />

    <title>
      
        
          开发minidhcp的感受记录
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://jimluo.github.io/main.css">
    
    
  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;bpf-vs-dpdk&#x2F;">
  

  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;https-redirect&#x2F;">
  

  
    <link rel="prerender"  href="https://jimluo.github.io/tags/linux/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "开发minidhcp的感受记录",
      "image": [],
      "datePublished": "2021-12-03T00:00:00+00:00",
      "dateModified": "2021-12-03T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "罗进"
      },
       "publisher": {
        "@type": "Organization",
        "name": "罗进",
        "logo": {
          "@type": "ImageObject",
          "url": "https://jimluo.github.io/icon.png"
        }
        
      }
      
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "",
          "item": "https://jimluo.github.io/"
        },
        
        {
          "@type": "ListItem",
          "position": 2,
          "name": "开发minidhcp的感受记录",
          "item": "https://jimluo.github.io/minidhcp/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="https:&#x2F;&#x2F;github.com&#x2F;jimluo">Github</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>开发minidhcp的感受记录</h1>
    <small>
      December 03, 2021
      
        - 
        <span class="tags">
          
            <a href="https://jimluo.github.io/tags/linux/">Linux</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <h2 id="kai-fa-minidhcpde-gan-shou-ji-lu">开发minidhcp的感受记录</h2>
<p>开发此服务目的是为网络流量分析和控制提供一种支持手段。具体方法是增加基于角色分配IP段的dhcp，并记录分配的设备的信息。</p>
<p>为了快速验证，在github上找到了<a href="https://github.com/coredhcp/coredhcp">coredhcp</a>，去掉了dhcp6及其繁冗的插件系统，优化重构了网络收发部分代码，重写了option的分配，加入了基于角色分配IP的功能，角色策略通过配置文件生效。<sup class="footnote-reference"><a href="#1">1</a></sup></p>
<h2 id="dhcpxie-yi-liu-cheng">dhcp协议流程</h2>
<p><img src="../images/minidhcp.png" alt="dhcp协议流程" /><sup class="footnote-reference"><a href="#2">2</a></sup></p>
<h3 id="dhcp-lease-sheng-ming-zhou-qi">DHCP lease 生命周期</h3>
<p>流程类似打工人租房，先电线杆子广播需求，收到房源电话后签合约，住到期后再续租。</p>
<p>在DHCP协议里描述的更严谨，用编程语言描述就是会有多个if else。</p>
<p>在计算机网络里会是一来一回的消息请求和确认。</p>
<p>类似盲人摸象，不同的视角说的都不全面。</p>
<p>用语言描述如下：</p>
<ol>
<li>此前没有过IP的客户端全网广播向DHCP服务申请，通过后分配一个IP时间限制的租约</li>
<li>已有过IP的客户端向授予它租约的DHCP服务器联系，以确认为其重新分配租约</li>
<li>租约过期后，客户端将联系最初授予租约的服务器续租</li>
<li>如果续租失败，客户端将尝试重新绑定到任何活跃的DHCP服务器</li>
<li>客户端主动放弃租约下线(goodbye curel world😢)</li>
</ol>
<p>以上5步在DHCP服务认知的世界里，用Allocation、Reallocation、Renewal、Rebinding和Release来描述。</p>
<p>当然在租房客的认知世界里，憧憬未来和负重前行也与房东的5步相对应。</p>
<h3 id="xian-shuo-xie-yi-de-allocation-da-jia-gong-tong-zun-shou-tong-yang-de-yue-ding">先说协议的Allocation，大家共同遵守同样的约定</h3>
<ol>
<li>client --DISCOVER(myMac, myID)--&gt; servers</li>
<li>client &lt;--OFFER(yourIP, your[DNS,Router,Mask,...], yourID)-- servers</li>
<li>client &lt;--IP[x]-- [1, n]IP from OFFER list </li>
<li>client --REQUEST(IP[x])--&gt; servers</li>
<li>client &lt;--ACK/MAK-- server</li>
</ol>
<p>用语言描述为</p>
<ol>
<li>广播找房</li>
<li>广受青睐，发来房源信息</li>
<li>挑选1个高性价比的房</li>
<li>广播告知自己已是有房之人</li>
<li>房东送来租房合同等你签字</li>
</ol>
<p>色不异空，空不异色，Reallocation、Renewal、Rebinding亦复如是</p>
<h2 id="serverwang-luo-shou-fa-xi-jie">server网络收发细节</h2>
<ul>
<li>服务端监听在67端口上，收到client请求后解析有icmp的信息，响应给client容错时要处理下，里面有网卡接口可以使用</li>
<li>对普通请求，自构建pcap响应原路返回。其他非正常消息在3层ip上icmp返回错误提醒</li>
<li>具体的发送使用libpacp，发送前要去掉自定义链路层的协议头部</li>
</ul>
<h2 id="optionschong-xi-jie">options种细节</h2>
<p>DHCP通过自定义增加多种不同的可选项来扩展，服务端返给客户端的option里有[ip, dns, mask, router, serverID...]可自由添加。</p>
<ul>
<li>分配时先根据客户端的mac来识别其角色，再根据配置文件中的range来分配具体的ip等信息</li>
<li>其他扩展在options的HandlerXXX dispatch去即可</li>
<li>需要客户端信息的，再options里可以对其提出，比如Vendor信息等</li>
<li>续租等信息在lease.txt可查可用</li>
<li>分配算法用的coredhcp的bitmap方式降低内存占用</li>
</ul>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/jimluo/minidhcp">源码地址</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://support.huawei.com/enterprise/zh/doc/EDOC1100156651/bb57bdaa/how-dhcp-works">图片来源</a></p>
</div>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    
      <div class="link">
        Previous <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;bpf-vs-dpdk&#x2F;">BPF技术介绍 - 生态和历史</a>
      </div>
    

    
      <div class="link">
        Next <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;https-redirect&#x2F;">HTTPS下强制认证</a>
      </div>
    

  </div>


    </main>
    <footer class="footer-page">
    
      
        <p>© 2022, Jim Luo | simple-dev-blog theme on Zola</p>

      
    
    </footer>
  </body>
</html>
