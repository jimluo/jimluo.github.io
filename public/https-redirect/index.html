<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
        --accent-overlay-color: #fff;
        --body-bg: #fff;
        --body-color: #000;
        --heading-color: #000;
        --table-bg-even: #f3f3f3;
        --table-border-bottom: #dddddd;
      }
      
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;38c5aeca4d24ddfe00.png" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;74cf6cb0a69d143300.png" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;b7f9a884e270881000.png" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;67ecf87962747c1700.png" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;73ad5705c9d7c81300.png" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;1c22f6dd0a34f84400.png" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;f9196920c2e9808000.png" />
      
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="输出是最好的学习方式" />
        <meta name="twitter:description" content="输出是最好的学习方式">
      
    

    
      <meta name="twitter:title" content="HTTPS下强制认证">
    

    
      <link rel="prerender" href="https:&#x2F;&#x2F;github.com&#x2F;jimluo" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" />

    <title>
      
        
          HTTPS下强制认证
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://jimluo.github.io/main.css">
    
    
  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;minidhcp&#x2F;">
  

  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;net-token&#x2F;">
  

  
    <link rel="prerender"  href="https://jimluo.github.io/tags/linux/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "HTTPS下强制认证",
      "image": [],
      "datePublished": "2022-01-10T00:00:00+00:00",
      "dateModified": "2022-01-10T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "罗进"
      },
       "publisher": {
        "@type": "Organization",
        "name": "罗进",
        "logo": {
          "@type": "ImageObject",
          "url": "https://jimluo.github.io/icon.png"
        }
        
      }
      
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "",
          "item": "https://jimluo.github.io/"
        },
        
        {
          "@type": "ListItem",
          "position": 2,
          "name": "HTTPS下强制认证",
          "item": "https://jimluo.github.io/https-redirect/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="https:&#x2F;&#x2F;github.com&#x2F;jimluo">Github</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>HTTPS下强制认证</h1>
    <small>
      January 10, 2022
      
        - 
        <span class="tags">
          
            <a href="https://jimluo.github.io/tags/linux/">Linux</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <p>网络安全准入对终端设备最开始和直接的就是强制其认证合法性。</p>
<p>原有基于HTTP重定向认证已失效，因为HTTP不安全。且浏览器都强制HSTS技术只能HTTPS。</p>
<p>怎么在HTTPS下还能重定向来认证？</p>
<p>住宿酒店和搭乘飞机时会对我们有所启发。接入提供的免费WIFI后会重定向。</p>
<p>结论就是诱使OS发出HTTP。</p>
<h3 id="ji-zhu-bei-jing">技术背景</h3>
<p>网络准入产品可以验证终端设备是否安全，使用强制网络门户认证技术实现此验证</p>
<ol>
<li>强制网络门户认证(captive portal），终端入网后，强制弹出浏览器的认证页面，强制用户认证后使用网络</li>
<li>HSTS(HTTP Strict Transport Security), 防止MiTM中间人攻击，浏览器强制使用HTTPS与服务器创建连接，用户无法发出HTTP请求</li>
<li>Captive Portal实现依赖于阶段性的HTTP劫持，当设备入网后，通过DHCP服务获取本机IP地址和网关地址后，发出的HTTP请求被劫持后返回重定向到指定的HTTP认证页面</li>
</ol>
<h3 id="cun-zai-wen-ti">存在问题</h3>
<ol>
<li>用户终端入网后先用浏览器手动访问HTTPS网站时，返回给终端浏览器的重定向响应，由于浏览器验证服务器证书不匹配会警告，无法实施强制认证，使此技术方案失效。如图</li>
</ol>
<p><img src="../images/https-redirect/1warning.png" alt="浏览器警告" /></p>
<ol start="2">
<li>用户终端网络在线时，由管控服务端实施准入策略，在未认证前断网，直到浏览器发出HTTP后被准入服务重定向后去认证。由于浏览器预制的HSTS域名缓存或服务端支持HSTS技术，HTTP被浏览器强制转换为HTTPS，致使浏览器验证服务器证书不匹配会警告，使此技术方案失效</li>
<li>原有准入系统实施基于浏览器http重定向的认证功能，在https下失效，报错证书不匹配，无法实施强制认证，使此技术方案失效。</li>
</ol>
<h3 id="ke-yi-li-yong-osde-yi-ge-ji-zhi">可以利用OS的一个机制</h3>
<p>操作系统：Windows/Linux/MacOS/Android/iOS下
刚入网时回探测是否需要认证，先探测有强制门户，再做认证</p>
<ol>
<li>终端操作系统入网后探测是否处于认证网关之下，多次尝试连接指定的HTTP的url，最长超时 30 秒</li>
<li>如果指定服务返回了204状态码，即未发现强制门户，不需要验证</li>
<li>如果指定服务返回HTTP重定向认证，即强制门户认证，认证后网络放行</li>
</ol>
<p><img src="../images/https-redirect/2captive-portal.png" alt="发出探测" /></p>
<p>图1 OS发出探测</p>
<p><img src="../images/https-redirect/3captive-portal-204.png" alt="收到响应，证明无强制门户" /></p>
<p>图2 OS收到无强制门户的204状态</p>
<p>以下是部分固定的探测强制门户的url</p>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>Windows :http://www.msftconnecttest.com/connecttest.txt</span><span>
</span><span>Google：http://www.gstatic.com/generate_204 / ， ...</span><span>
</span><span>Android:https://www.google.com/generate_204，...    </span><span>
</span><span>小米： http://connect.rom.miui.com/generate_204</span><span>
</span><span>华为： http://connectivitycheck.platform.hicloud.com/generate_204</span><span>
</span></code></pre>
<h3 id="ru-he-li-yong-osde-zhe-ge-ji-zhi">如何利用OS的这个机制</h3>
<p>在交换机或浏览器上处理，诱发OS发出强制门户认证探测</p>
<p>两种方案各有优劣，也可同时使用</p>
<ul>
<li>交换机方案依赖交换机的控制，普通服务没有控制交换机的权限</li>
<li>浏览器方案依赖用户先打开浏览器</li>
</ul>
<p><img src="../images/https-redirect/4topology.png" alt="网络拓扑" /></p>
<p>图3 HTTPS重定向的网络拓扑</p>
<h2 id="ji-yu-jiao-huan-ji-de-ji-zhu-fang-an">基于交换机的技术方案</h2>
<ol>
<li>准入服务控制交换机对终端断网后再开网</li>
<li>终端重新入网诱发其探测强制门户</li>
<li>Windows尝试强制认证，访问http://www.msftconnecttest.com/connecttest.txt</li>
<li>终端桌面上托盘中的网络图标闪烁，提示用户点击图标，会打开浏览器并跳入认证页面</li>
<li>准入服务流量截获HTTP请求并重定向到认证页面</li>
</ol>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>终端               交换机        强制门户          准入服务</span><span>
</span><span> |&lt;---断网后再开网----|             |</span><span>
</span><span> |                   |             |</span><span>
</span><span> |-------------探测强制门户--------&gt;|----捕获HTTP----&gt;|</span><span>
</span><span> |                   |             |                 |</span><span>
</span><span> |&lt;------------发送模仿强制门户的重定向认证------------|</span><span>
</span></code></pre>
<p>表1 基于交换机的HTTPS重定向</p>
<h3 id="jiao-huan-ji-shi-shi-kong-zhi-ji-zhu">交换机实施控制技术</h3>
<ol>
<li>与终端直连的交换机将终端地址通过snmp trap上报准入服务</li>
<li>准入服务给指定终端断网再入网snmpset  [up / down]</li>
</ol>
<h2 id="ji-yu-liu-lan-qi-zheng-shu-de-ji-zhu-fang-an">基于浏览器证书的技术方案</h2>
<p>客户端浏览器	网络通讯	服务器(流量镜像)</p>
<ol>
<li>浏览器发起请求，例如https://www.wechat.cn</li>
<li>准入服务识别HTTPS请求，生成自签名的ssl证书（可缓存证书重复利用），返回给终端浏览器</li>
<li>准入服务判断证书，包含公钥，颁发者	返回证书给终端浏览器</li>
<li>终端浏览器判定证书字段有误，终止后面数据传输的流程。进入门户认证流程，</li>
<li>发起http请求，寻找门户http://www.msftconnecttest.com/connecttest.txt</li>
<li>准入服务识别请求，修改门户地址，返回给终端浏览器</li>
<li>终端浏览器打开新tab页跳转到指定网址</li>
</ol>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>终端               交换机        强制门户          准入服务</span><span>
</span><span> |-----------HTTPS浏览网页时SSL握手验证证书----------&gt;|</span><span>
</span><span> |&lt;----------------发送自签名的ssl证书----------------|</span><span>
</span><span> |---------判定证书字段有误，进入门户认证流程---------&gt;|</span><span>
</span><span> |                   |             |</span><span>
</span><span> |-------------探测强制门户--------&gt;|----捕获HTTP----&gt;|</span><span>
</span><span> |                   |             |                |</span><span>
</span><span> |&lt;------------发送模仿强制门户的重定向认证------------|</span><span>
</span></code></pre>
<p>表2 基于浏览器证书重定向</p>
<h3 id="shi-xian-te-dian">实现特点</h3>
<ol>
<li>解决了现有产品在HTTPS下强制门户认证的失效问题</li>
<li>高性能，同时大并发量下对HTTPS强制门户认证。基于BPF实现</li>
<li>绕过HSTS对HTTPS强制使用，实现HTTPS时也能实施强制门户认证</li>
<li>基于强制门户发出的HTTP探测，还能用于其他安全业务</li>
</ol>
<h2 id="dai-ma-mu-lu-jie-gou">代码目录结构<sup class="footnote-reference"><a href="#1">1</a></sup></h2>
<pre data-lang="sh" style="background-color:#f9f9f9;color:#111111;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#c82728;">bpf/</span><span style="color:#4271ae;"> 驱动</span><span>
</span><span>   </span><span style="color:#c82728;">lib/</span><span style="color:#4271ae;"> 协议库</span><span>
</span><span>      </span><span style="color:#c82728;">api.h</span><span style="color:#4271ae;">  公用依赖头</span><span>
</span><span>      </span><span style="color:#c82728;">eth.h</span><span style="color:#4271ae;">  以太帧处理</span><span>
</span><span>      </span><span style="color:#c82728;">ipv4.h</span><span style="color:#4271ae;"> ip帧处理</span><span>
</span><span>      </span><span style="color:#c82728;">tcp.h</span><span style="color:#4271ae;">  tcp帧处理</span><span>
</span><span>      </span><span style="color:#c82728;">http.h</span><span style="color:#4271ae;"> http处理</span><span>
</span><span>      </span><span style="color:#c82728;">dhcp.h</span><span style="color:#4271ae;"> dhcp收集终端信息</span><span>
</span><span>      </span><span style="color:#c82728;">os_filter.h</span><span style="color:#4271ae;">  过滤os</span><span>
</span><span>      </span><span style="color:#c82728;">metrics.h</span><span style="color:#4271ae;">  系统性能</span><span>
</span><span>   </span><span style="color:#c82728;">linux/</span><span style="color:#4271ae;"> 内核类型</span><span>
</span><span>   </span><span style="color:#c82728;">test/</span><span style="color:#4271ae;"> 单元测试</span><span>
</span><span>   </span><span style="color:#c82728;">bpf.c</span><span style="color:#4271ae;"> 驱动</span><span>
</span><span style="color:#c82728;">Makefile</span><span style="color:#4271ae;">   构建</span><span>
</span><span style="color:#c82728;">main.go</span><span style="color:#4271ae;">    加载入口</span><span>
</span><span style="color:#c82728;">program.go</span><span style="color:#4271ae;"> 加载器</span><span>
</span><span style="color:#c82728;">maps.go</span><span style="color:#4271ae;">    内核与用户态传参字典</span><span>
</span><span style="color:#c82728;">npf.go</span><span style="color:#4271ae;">     驱动上报</span><span>
</span><span style="color:#c82728;">npf_bpfel.go</span><span style="color:#4271ae;">  自动生成加载驱动</span><span>
</span><span style="color:#c82728;">snmp.go</span><span style="color:#4271ae;">    snmp下启停端口</span><span>
</span><span style="color:#c82728;">tracer.go</span><span style="color:#4271ae;">  traceroute查找终端机器直连的交换机</span><span>
</span></code></pre>
<h2 id="qu-dong-liu-cheng">驱动流程</h2>
<p>从2层到5层，eth-&gt;ip4-&gt;tcp-&gt;http</p>
<ol>
<li>网络入口 xdp_npf_prog(struct xdp_md* ctx)</li>
<li>struct pkthdr pkt{data_cursor, data_begin, data_end}数据帧封装</li>
<li>过滤http及重定向
<ol>
<li>config verify 读取配置，交换机ip等</li>
<li>eth parse and verify, 只留IP包</li>
<li>ipv4 parse and verify, host pkt pass</li>
<li>tcp parse and verify
<ol>
<li>tcp options filter, find and save token to hashmap</li>
</ol>
</li>
<li>os filter</li>
<li>http parse and filter os</li>
<li>lookup hashmap of token</li>
<li>http parse and verify </li>
<li>redirect http  本机debug时关闭</li>
</ol>
</li>
</ol>
<h2 id="jia-zai-liu-cheng-program-go-npf-bpfel-go">加载流程   program.go npf_bpfel.go</h2>
<ol>
<li>cfg := LoadConfig(&quot;config&quot;) 加载本地配置</li>
<li>npf := NewNpf(cfg) =&gt; npf.go 驱动加载</li>
<li>loadNpfObjects(&amp;bpf) =&gt; npf_bpfel.go  初始化</li>
<li>LoadProg(bpf.npfPrograms.XdpNpfProg.FD()) =&gt; program.go 加载
<ol>
<li>GetIface(linkname) 获取网卡interface</li>
<li>AttachProg(）将启动挂载到网卡interface</li>
</ol>
</li>
<li>perf.NewReader(PKT_INFO_EVENTS_MAP） 挂载事件</li>
<li>npf.SetKernelConfig() 构造配置下传</li>
<li>redirectUrlLinux 重定向地址</li>
<li>ipHost  本机地址</li>
<li>macHost 交换机mac</li>
<li>npf.Listen() 监听事件
<ol>
<li>HandleRecord() 解析打印事件</li>
</ol>
</li>
</ol>
<h2 id="httpszhong-ding-xiang-liu-cheng-snmp-go-tracer-go">https重定向流程 snmp.go tracer.go</h2>
<ol>
<li>snmpscan() 主入口
<ol>
<li>NewSnmp(p)</li>
<li>Connect()</li>
<li>QueryIfaces() 获取所有端口</li>
<li>DownUpIface 关接口</li>
<li>UpIface 开接口</li>
</ol>
</li>
<li>Trace() 主入口
<ol>
<li>DefaultTracer 构建可配置的tracer
<ol>
<li>Trace()
<ol>
<li>ping</li>
<li>Receive</li>
</ol>
</li>
<li>touch，记录每一跳</li>
<li>Add，判断符合RTT或srcIP后添加</li>
</ol>
</li>
<li>hops，反向过滤所有跳，匹配上过滤</li>
</ol>
</li>
</ol>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p><a href="https://github.com/jimluo/redirectHTTPS">RedirectHTTPS</a></p>
</div>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    
      <div class="link">
        Previous <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;minidhcp&#x2F;">开发minidhcp的感受记录</a>
      </div>
    

    
      <div class="link">
        Next <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;net-token&#x2F;">基于Rust和BPF技术的网络TCP水印</a>
      </div>
    

  </div>


    </main>
    <footer class="footer-page">
    
      
        <p>© 2022, Jim Luo | simple-dev-blog theme on Zola</p>

      
    
    </footer>
  </body>
</html>
