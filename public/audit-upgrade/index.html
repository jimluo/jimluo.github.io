<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      :root {
        --accent-color: #05a081;
        --accent-color-light: #82d0c0;
        --accent-overlay-color: #fff;
        --body-bg: #fff;
        --body-color: #000;
        --heading-color: #000;
        --table-bg-even: #f3f3f3;
        --table-border-bottom: #dddddd;
      }
      
    </style>

    <meta name="theme-color" content="#05a081" />

    
      <link rel="icon" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;106e1fb7d8c11fe100.png" />
      <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;38c5aeca4d24ddfe00.png" />
      <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;74cf6cb0a69d143300.png" />
      <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;b7f9a884e270881000.png" />
      <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;67ecf87962747c1700.png" />
      <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;73ad5705c9d7c81300.png" />
      <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;1c22f6dd0a34f84400.png" />
      <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;f9196920c2e9808000.png" />
      
    

    

    <meta property="og:type" content="website">

    <meta name="twitter:card" content="summary">

    

    

    
      
        <meta name="description" content="输出是最好的学习方式" />
        <meta name="twitter:description" content="输出是最好的学习方式">
      
    

    
      <meta name="twitter:title" content="CWPP中Audit的升级换代">
    

    
      <link rel="prerender" href="https:&#x2F;&#x2F;github.com&#x2F;jimluo" />
    

    <link rel="prefetch" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" />

    <title>
      
        
          CWPP中Audit的升级换代
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://jimluo.github.io/main.css">
    
    
  
    <link rel="prerender" href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;asset-discovery&#x2F;">
  

  

  
    <link rel="prerender"  href="https://jimluo.github.io/tags/linux/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "CWPP中Audit的升级换代",
      "image": [],
      "datePublished": "2022-05-09T00:00:00+00:00",
      "dateModified": "2022-05-09T00:00:00+00:00",
      "author": {
        "@type": "Person",
        "name": "罗进"
      },
       "publisher": {
        "@type": "Organization",
        "name": "罗进",
        "logo": {
          "@type": "ImageObject",
          "url": "https://jimluo.github.io/icon.png"
        }
        
      }
      
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "",
          "item": "https://jimluo.github.io/"
        },
        
        {
          "@type": "ListItem",
          "position": 2,
          "name": "CWPP中Audit的升级换代",
          "item": "https://jimluo.github.io/audit-upgrade/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
      <header>
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;jimluo.github.io&#x2F;processed_images&#x2F;2abb4f8ff69df78500.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="https:&#x2F;&#x2F;github.com&#x2F;jimluo">Github</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>CWPP中Audit的升级换代</h1>
    <small>
      May 09, 2022
      
        - 
        <span class="tags">
          
            <a href="https://jimluo.github.io/tags/linux/">Linux</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <p>技术背景是CWPP(Cloud Workload Protection Platforms)云工作负载保护平台，通常基于代理在计算机中永久运行，收集与安全相关的数据和事件，并将其发送到基于云服务分析后通知用户相应的潜在安全威胁。</p>
<p>其中的一个子系统audit，是一个用于收集记录系统、内核、用户进程发生的行为事件的被动防御的安全审计系统。该系统可以可靠地收集有关上任何与安全相关事件的信息，如记录文件访问、网络访问、用户指令、系统调用和系统安全事件。</p>
<p>随着时间的推移，内核的发展，其存在问题日显突出</p>
<ol>
<li>性能开销大：开启服务的支付卡安全标准，系统吞吐率下降30%，系统调用开销下降50%，上下文切换下降10%，其他下降%2-10%左右</li>
<li>不能灵活调节性能：只是开启服务但不执行，系统吞吐率下降20%，系统调用开销下降35%，其他下降%2-10%左右</li>
<li>对docker容器支持不够，且对docker及其服务的监测达不到安全发现的效果</li>
</ol>
<h3 id="auditxi-tong-zi-xi-tong">audit系统子系统</h3>
<p><img src="../images/audit.png" alt="audit" /></p>
<ul>
<li>auditd：审计守护程序负责将通过审计内核接口生成并由应用程序和系统活动触发的审计消息写入磁盘。</li>
<li>auditctl：控制审计接口的日志生成参数和内核设置，以及用于确定要跟踪哪些事件的规则集</li>
<li>aureport：创建自定义报告</li>
<li>ausearch：搜索审计日志中的特定的事件</li>
<li>audispd：通知其他应用程序，而不是将其写入磁盘上的审计日志中</li>
</ul>
<h3 id="ke-ti-dai-de-5chong-ji-zhu-bi-jiao">可替代的5种技术比较</h3>
<table><thead><tr><th>发布年份</th><th>采集框架</th><th>性能</th><th>可编程控制</th><th>稳定性</th><th>内置于内核</th></tr></thead><tbody>
<tr><td>2004</td><td>Linux Audit</td><td>差</td><td>否</td><td>高</td><td>是</td></tr>
<tr><td>2009</td><td>SystemTap</td><td>良</td><td>是</td><td>低</td><td>否</td></tr>
<tr><td>2006</td><td>LTTng</td><td>良</td><td>否</td><td>低</td><td>否</td></tr>
<tr><td>2009</td><td>Perf/ftrace</td><td>优</td><td>否</td><td>高</td><td>是</td></tr>
<tr><td>2014</td><td>BPF</td><td>优</td><td>是</td><td>高</td><td>是</td></tr>
</tbody></table>
<h3 id="xing-neng-di-de-yuan-yin">性能低的原因</h3>
<p>Audit独立于kprobe、tracepoint之外的数据源，通过syscall和文件操作等内核源码上插入自定义的钩子函数实现监控，于2004年加入内核，相比于其他技术性能差</p>
<h3 id="bpfji-zhu-de-you-shi">BPF技术的优势</h3>
<ul>
<li>稳定：通过验证器，可防止错误引起的内核崩溃</li>
<li>免安装：无需安装，可动态加载和卸载</li>
<li>可编程控制：支持开发者插入自定义的代码逻辑</li>
</ul>
<h3 id="bpfde-lie-shi">BPF的劣势</h3>
<ul>
<li>需要高版本的Linux内核，V3.x版本功能不全，V2.x无BPF支持。</li>
<li>低版本Linux使用原有audit或perf等实现</li>
</ul>
<h3 id="yong-bpfti-dai-auditde-fang-an">用BPF替代Audit的方案</h3>
<ol>
<li>使用BPF实现已有linux audit子系统功能。实现细节见下一节</li>
<li>根据系统版本选择安装，老系统使用原有audit或perf，V4.x及以上系统使用BPF</li>
<li>提供自监测系统，监控和配置性能指标，超过指标后，执行对应缓解措施</li>
<li>提供实时通知机制，遇到配置项，通知其他接入系统协同完成对应缓解措施</li>
<li>提供docker内监测和多docker间聚合事件能力，尤其是cgroup和网络等事件，增强docker的审计功能</li>
</ol>
<h3 id="bpfdui-linux-auditzi-xi-tong-shi-xian-xi-jie">BPF对linux audit子系统实现细节</h3>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>                   Agent        </span><span>
</span><span>策略下发  |  事件聚合 |   通知协同  |  性能监测 </span><span>
</span><span>                    BPF        </span><span>
</span><span>    Ring Buffer ↑    |     ↓ BPF Map    </span><span>
</span><span>         System call | syscall 系统调用    挂载点</span><span>
</span><span>     VFS/File system | 文件操作    挂载点</span><span>
</span><span>                  硬件驱动        </span><span>
</span></code></pre>
<ol>
<li>针对audit的监控syscall和文件操作，BPF也增加相同接入监控</li>
<li>Agent通过BPF map设置配置策略到BPF驱动，动态管控监控行为</li>
<li>通过RingBuffer将BPF驱动实时发送事件到监控应用agent</li>
<li>Agent分成4部分策略下发、事件聚合、通知协同、性能监测</li>
</ol>
<h3 id="zhu-ji-shen-ji-xi-tong-liu-cheng">主机审计系统流程</h3>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>                  ↓</span><span>
</span><span>                策略下发</span><span>
</span><span>在后台服务中，管理员配置设计策略并下发</span><span>
</span><span>                  ↓</span><span>
</span><span>    主机agent接收策略，写入BPF map</span><span>
</span><span>                  ↓</span><span>
</span><span>        主机BPF驱动执行策略</span><span>
</span><span>                  ↓</span><span>
</span><span>BPF驱动收集系统调用syscal和文件系统操作事件</span><span>
</span></code></pre>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>                事件聚合</span><span>
</span><span>在后台服务中，聚合分类这些事件</span><span>
</span><span>                  ↑</span><span>
</span><span>在后台服务中，收集多台主机上报的审计事件</span><span>
</span><span>                  ↑</span><span>
</span><span>        由agent上报发送给后台服务</span><span>
</span><span>                  ↑</span><span>
</span><span>            事件内容写入Ring Buffer</span><span>
</span><span>                  ↑</span><span>
</span><span>由BPF驱动收集系统调用syscal和文件系统操作事件</span><span>
</span><span>                  ↑</span><span>
</span><span>        主机agent根据下发策略要求</span><span>
</span></code></pre>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>                通知协同</span><span>
</span><span>将聚合分类安全事件通知其他安全服务，如威胁狩猎分析</span><span>
</span><span>                  ↓</span><span>
</span><span>        其他安全服务生成对应的安全策略</span><span>
</span><span>                  ↓</span><span>
</span><span>        将安全策略通知系统审计服务</span><span>
</span><span>                  ↓</span><span>
</span><span>    优化更新主机审计系统自身的安全策略</span><span>
</span></code></pre>
<pre style="background-color:#f9f9f9;color:#111111;"><code><span>                性能监测</span><span>
</span><span>    主机agent采集主机自身性能指标</span><span>
</span><span>                  ↓</span><span>
</span><span>    根据下发策略扩大或减小监测挂载点</span><span>
</span><span>                  ↓</span><span>
</span><span>    动态控制审计系统的对系统的负荷</span><span>
</span></code></pre>
<h3 id="sheng-ji-ti-huan-hou-de-you-yi-xiao-guo">升级替换后的有益效果</h3>
<ol>
<li>高性能的收集安全信息</li>
<li>可动态加载的探针，动态分配系统开销</li>
<li>可兼容新旧系统的技术栈，适应老系统(老系统不支持新的技术)</li>
<li>可实时发现安全威胁，及时上报或紧急处理</li>
<li>可以与系统其他安全服务协同</li>
</ol>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    
      <div class="link">
        Previous <br />
        <a href="https:&#x2F;&#x2F;jimluo.github.io&#x2F;asset-discovery&#x2F;">终端资产的全面发现管理</a>
      </div>
    

    

  </div>


    </main>
    <footer class="footer-page">
    
      
        <p>© 2022, Jim Luo | simple-dev-blog theme on Zola</p>

      
    
    </footer>
  </body>
</html>
