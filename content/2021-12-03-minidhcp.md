+++
title = "å¼€å‘minidhcpçš„æ„Ÿå—è®°å½•"
[taxonomies]
tags = [ "Linux" ]
+++

## å¼€å‘minidhcpçš„æ„Ÿå—è®°å½•

å¼€å‘æ­¤æœåŠ¡ç›®çš„æ˜¯ä¸ºç½‘ç»œæµé‡åˆ†æå’Œæ§åˆ¶æä¾›ä¸€ç§æ”¯æŒæ‰‹æ®µã€‚å…·ä½“æ–¹æ³•æ˜¯å¢åŠ åŸºäºè§’è‰²åˆ†é…IPæ®µçš„dhcpï¼Œå¹¶è®°å½•åˆ†é…çš„è®¾å¤‡çš„ä¿¡æ¯ã€‚

ä¸ºäº†å¿«é€ŸéªŒè¯ï¼Œåœ¨githubä¸Šæ‰¾åˆ°äº†[coredhcp](https://github.com/coredhcp/coredhcp)ï¼Œå»æ‰äº†dhcp6åŠå…¶ç¹å†—çš„æ’ä»¶ç³»ç»Ÿï¼Œä¼˜åŒ–é‡æ„äº†ç½‘ç»œæ”¶å‘éƒ¨åˆ†ä»£ç ï¼Œé‡å†™äº†optionçš„åˆ†é…ï¼ŒåŠ å…¥äº†åŸºäºè§’è‰²åˆ†é…IPçš„åŠŸèƒ½ï¼Œè§’è‰²ç­–ç•¥é€šè¿‡é…ç½®æ–‡ä»¶ç”Ÿæ•ˆã€‚[^1]

## dhcpåè®®æµç¨‹

![dhcpåè®®æµç¨‹](../images/minidhcp.png)[^2]

### DHCP lease ç”Ÿå‘½å‘¨æœŸ
æµç¨‹ç±»ä¼¼æ‰“å·¥äººç§Ÿæˆ¿ï¼Œå…ˆç”µçº¿æ†å­å¹¿æ’­éœ€æ±‚ï¼Œæ”¶åˆ°æˆ¿æºç”µè¯åç­¾åˆçº¦ï¼Œä½åˆ°æœŸåå†ç»­ç§Ÿã€‚

åœ¨DHCPåè®®é‡Œæè¿°çš„æ›´ä¸¥è°¨ï¼Œç”¨ç¼–ç¨‹è¯­è¨€æè¿°å°±æ˜¯ä¼šæœ‰å¤šä¸ªif elseã€‚

åœ¨è®¡ç®—æœºç½‘ç»œé‡Œä¼šæ˜¯ä¸€æ¥ä¸€å›çš„æ¶ˆæ¯è¯·æ±‚å’Œç¡®è®¤ã€‚

ç±»ä¼¼ç›²äººæ‘¸è±¡ï¼Œä¸åŒçš„è§†è§’è¯´çš„éƒ½ä¸å…¨é¢ã€‚

ç”¨è¯­è¨€æè¿°å¦‚ä¸‹ï¼š
1. æ­¤å‰æ²¡æœ‰è¿‡IPçš„å®¢æˆ·ç«¯å…¨ç½‘å¹¿æ’­å‘DHCPæœåŠ¡ç”³è¯·ï¼Œé€šè¿‡ååˆ†é…ä¸€ä¸ªIPæ—¶é—´é™åˆ¶çš„ç§Ÿçº¦
2. å·²æœ‰è¿‡IPçš„å®¢æˆ·ç«¯å‘æˆäºˆå®ƒç§Ÿçº¦çš„DHCPæœåŠ¡å™¨è”ç³»ï¼Œä»¥ç¡®è®¤ä¸ºå…¶é‡æ–°åˆ†é…ç§Ÿçº¦
3. ç§Ÿçº¦è¿‡æœŸåï¼Œå®¢æˆ·ç«¯å°†è”ç³»æœ€åˆæˆäºˆç§Ÿçº¦çš„æœåŠ¡å™¨ç»­ç§Ÿ
4. å¦‚æœç»­ç§Ÿå¤±è´¥ï¼Œå®¢æˆ·ç«¯å°†å°è¯•é‡æ–°ç»‘å®šåˆ°ä»»ä½•æ´»è·ƒçš„DHCPæœåŠ¡å™¨
5. å®¢æˆ·ç«¯ä¸»åŠ¨æ”¾å¼ƒç§Ÿçº¦ä¸‹çº¿(goodbye curel worldğŸ˜¢)

ä»¥ä¸Š5æ­¥åœ¨DHCPæœåŠ¡è®¤çŸ¥çš„ä¸–ç•Œé‡Œï¼Œç”¨Allocationã€Reallocationã€Renewalã€Rebindingå’ŒReleaseæ¥æè¿°ã€‚

å½“ç„¶åœ¨ç§Ÿæˆ¿å®¢çš„è®¤çŸ¥ä¸–ç•Œé‡Œï¼Œæ†§æ†¬æœªæ¥å’Œè´Ÿé‡å‰è¡Œä¹Ÿä¸æˆ¿ä¸œçš„5æ­¥ç›¸å¯¹åº”ã€‚

### å…ˆè¯´åè®®çš„Allocationï¼Œå¤§å®¶å…±åŒéµå®ˆåŒæ ·çš„çº¦å®š
1. client --DISCOVER(myMac, myID)--> servers
2. client <--OFFER(yourIP, your[DNS,Router,Mask,...], yourID)-- servers
3. client <--IP[x]-- [1, n]IP from OFFER list 
4. client --REQUEST(IP[x])--> servers
5. client <--ACK/MAK-- server

ç”¨è¯­è¨€æè¿°ä¸º
1. å¹¿æ’­æ‰¾æˆ¿
2. å¹¿å—é’çï¼Œå‘æ¥æˆ¿æºä¿¡æ¯
3. æŒ‘é€‰1ä¸ªé«˜æ€§ä»·æ¯”çš„æˆ¿
4. å¹¿æ’­å‘ŠçŸ¥è‡ªå·±å·²æ˜¯æœ‰æˆ¿ä¹‹äºº
5. æˆ¿ä¸œé€æ¥ç§Ÿæˆ¿åˆåŒç­‰ä½ ç­¾å­—

è‰²ä¸å¼‚ç©ºï¼Œç©ºä¸å¼‚è‰²ï¼ŒReallocationã€Renewalã€Rebindingäº¦å¤å¦‚æ˜¯

## serverç½‘ç»œæ”¶å‘ç»†èŠ‚
- æœåŠ¡ç«¯ç›‘å¬åœ¨67ç«¯å£ä¸Šï¼Œæ”¶åˆ°clientè¯·æ±‚åè§£ææœ‰icmpçš„ä¿¡æ¯ï¼Œå“åº”ç»™clientå®¹é”™æ—¶è¦å¤„ç†ä¸‹ï¼Œé‡Œé¢æœ‰ç½‘å¡æ¥å£å¯ä»¥ä½¿ç”¨
- å¯¹æ™®é€šè¯·æ±‚ï¼Œå“åº”åŸè·¯2å±‚ethernetè¿”å›ã€‚å…¶ä»–éæ­£å¸¸æ¶ˆæ¯åœ¨3å±‚ipä¸Šicmpè¿”å›é”™è¯¯æé†’
- å…·ä½“çš„å‘é€ä½¿ç”¨libpacpï¼Œå‘é€å‰è¦å»æ‰è‡ªå®šä¹‰é“¾è·¯å±‚çš„åè®®å¤´éƒ¨

## optionsç§ç»†èŠ‚
DHCPé€šè¿‡è‡ªå®šä¹‰å¢åŠ å¤šç§ä¸åŒçš„å¯é€‰é¡¹æ¥æ‰©å±•ï¼ŒæœåŠ¡ç«¯è¿”ç»™å®¢æˆ·ç«¯çš„optioné‡Œæœ‰[ip, dns, mask, router, serverID...]å¯è‡ªç”±æ·»åŠ ã€‚
- åˆ†é…æ—¶å…ˆæ ¹æ®å®¢æˆ·ç«¯çš„macæ¥è¯†åˆ«å…¶è§’è‰²ï¼Œå†æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„rangeæ¥åˆ†é…å…·ä½“çš„ipç­‰ä¿¡æ¯
- å…¶ä»–æ‰©å±•åœ¨optionsçš„HandlerXXX dispatchå»å³å¯
- éœ€è¦å®¢æˆ·ç«¯ä¿¡æ¯çš„ï¼Œå†optionsé‡Œå¯ä»¥å¯¹å…¶æå‡ºï¼Œæ¯”å¦‚Vendorä¿¡æ¯ç­‰
- ç»­ç§Ÿç­‰ä¿¡æ¯åœ¨lease.txtå¯æŸ¥å¯ç”¨
- åˆ†é…ç®—æ³•ç”¨çš„coredhcpçš„bitmapæ–¹å¼é™ä½å†…å­˜å ç”¨

[^1]: [æºç åœ°å€](https://github.com/jimluo/minidhcp)
[^2]: [å›¾ç‰‡æ¥æº](https://support.huawei.com/enterprise/zh/doc/EDOC1100156651/bb57bdaa/how-dhcp-works)